### 一。 Eureka原理:
    Eureka 是 Netflix 出品的用于实现服务注册和发现的工具。 Spring Cloud 集成了 Eureka，并提供了开箱即用的支持。其中， Eureka 又可细分为 Eureka Server 和 Eureka Client。
 ![原理图](..\noteImages\Eureka原理图.png)
#### 1. 基本原理简介：
上图是来自eureka的官方架构图，这是基于集群配置的eureka； 
- 处于不同节点的eureka通过Replicate进行数据同步 
- Application Service为服务提供者 
- Application Client为服务消费者 
- Make Remote Call完成一次服务调用
服务启动后向Eureka注册，Eureka Server会将注册信息向其他Eureka Server进行同步，当服务消费者要调用服务提供者，则向服务注册中心获取服务提供者地址，然后会将服务提供者地址缓存在本地，下次再调用时，则直接从本地缓存中取，完成一次调用。
当服务注册中心Eureka Server检测到服务提供者因为宕机、网络原因不可用时，则在服务注册中心将服务置为DOWN状态，并把当前服务提供者状态向订阅者发布，订阅过的服务消费者更新本地缓存。
服务提供者在启动后，周期性（默认30秒）向Eureka Server发送心跳，以证明当前服务是可用状态。Eureka Server在一定的时间（默认90秒）未收到客户端的心跳，则认为服务宕机，注销该实例。
#### 2. Eureka的自我保护机制
在默认配置中，Eureka
Server在默认90s没有得到客户端的心跳，则注销该实例，但是往往因为微服务跨进程调用，网络通信往往会面临着各种问题，比如微服务状态正常，但是因为网络分区故障时，Eureka
Server注销服务实例则会让大部分微服务不可用，这很危险，因为服务明明没有问题。
为了解决这个问题，Eureka 有自我保护机制，通过在Eureka
Server配置如下参数，可启动保护机制  
```properties
eureka.server.enable-self-preservation=true
```
它的原理是，当Eureka Server节点在短时间内丢失过多的客户端时（可能发送了网络故障），那么这个节点将进入自我保护模式，不再注销任何微服务，当网络故障回复后，该节点会自动退出自我保护模式。
自我保护模式的架构哲学是宁可放过一个，决不可错杀一 
#### 3. 作为服务注册中心，Eureka比Zookeeper好在哪里
著名的CAP理论指出，一个分布式系统不可能同时满足C(一致性)、A(可用性)和P(分区容错性)。由于分区容错性在是分布式系统中必须要保证的，因此我们只能在A和C之间进行权衡。在此Zookeeper保证的是CP,
而Eureka则是AP。    
##### 3.1 Zookeeper保证CP
当向注册中心查询服务列表时，我们可以容忍注册中心返回的是几分钟以前的注册信息，但不能接受服务直接down掉不可用。也就是说，服务注册功能对可用性的要求要高于一致性。但是zk会出现这样一种情况，当master节点因为网络故障与其他节点失去联系时，剩余节点会重新进行leader选举。问题在于，选举leader的时间太长，30
\~ 120s,
且选举期间整个zk集群都是不可用的，这就导致在选举期间注册服务瘫痪。在云部署的环境下，因网络问题使得zk集群失去master节点是较大概率会发生的事，虽然服务能够最终恢复，但是漫长的选举时间导致的注册长期不可用是不能容忍的。
##### 3.2 Eureka保证AP
Eureka看明白了这一点，因此在设计时就优先保证可用性。Eureka各个节点都是平等的，几个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和查询服务。而Eureka的客户端在向某个Eureka注册或时如果发现连接失败，则会自动切换至其它节点，只要有一台Eureka还在，就能保证注册服务可用(保证可用性)，只不过查到的信息可能不是最新的(不保证强一致性)。除此之外，Eureka还有一种自我保护机制，如果在15分钟内超过85%的节点都没有正常的心跳，那么Eureka就认为客户端与注册中心出现了网络故障，此时会出现以下几种情况： 
1. Eureka不再从注册列表中移除因为长时间没收到心跳而应该过期的服务 
2. Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其它节点上(即保证当前节点依然可用) 
3. 当网络稳定时，当前实例新的注册信息会被同步到其它节点中

因此， Eureka可以很好的应对因网络故障导致部分节点失去联系的情况，而不会像zookeeper那样使整个注册服务瘫痪。

##### 4. 总结 
1.  Eureka和Zookepper都可以作为注册中心    
2. Eureka取CAP中的AP，注重可用性。Zookepper取CAP理论中的CP强调高的一致性    
3. Cloud官网Eureka架构图指出，Eureka是去中心化的，当网络出现分区故障时，可以独立的为各自的子网下的机器提供服务。 Zookepper中，当出现分区故障，Zookepper集群进行各自服务的提出，然后根据规定在各自的集群下进行Leader选举， 但参选人数不过半时，此集群挂掉。(脑裂中就存在这种问题导致它不具有可用性)
4. Eureka常用于SpringCloud下产物的注册中心,如：微服务的注册中心   
Zookepper是分布式下的注册中心，如：Dubbo、Hadoop类似的集群的服务注册中心   
5. Eureka和Zookeeper的选取：看自己程序的需要，是需要AP还是CP,根据具体的场景来选取   
6. 对于Zookepper和Eureka中关于宕掉服务的可用问题：   
首先：宕掉指的是什么宕掉？如果是提供服务的机器宕掉，即注册一个服务到Zookepper中的那个服务宕掉，那么就是不可用的   
反之：如果宕掉的是Zookepper或者Eureka，那么服务调用方还是有可能调用成功服务的。因为存在本地缓存的服务列表。   
当提供服务的机器宕掉之后，服务就不可以访问了。大家一般说的宕掉后服务可用指的不是服务宕掉，而是指服务注册中心宕掉时 可访问，因为调用服务者本地会缓存之前的服务调用列表。
#### 二。Eureka集群配置

###### 引用：https://www.cnblogs.com/snowjeblog/p/8821325.html
 
 
 